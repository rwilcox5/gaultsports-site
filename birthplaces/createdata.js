statept = {'CO':0,'AL':0,'CA':0,'FL':0,'PA':0,'VT':0,'NE':0,'OH':0,'AR':0,'GA':0,'MI':0,'MA':0,'OK':0,'NC':0,'IL':0,'TX':0,'WA':0,'MO':0,'AZ':0,'NJ':0,'WI':0,'IN':0,'LA':0,'UT':0,'NM':0,'KY':0,'MD':0,'KS':0,'WV':0,'NY':0,'HI':0,'SC':0,'OR':0,'SD':0,'TN':0,'MS':0,'VA':0,'ME':0,'CT':0,'RI':0,'DC':0,'NV':0,'MN':0,'IA':0,'DE':0,'MT':0,'AK':0,'NH':0,'ND':0,'WY':0,'ID':0};
statetops = {'CO':[],'AL':[],'CA':[],'FL':[],'PA':[],'VT':[],'NE':[],'OH':[],'AR':[],'GA':[],'MI':[],'MA':[],'OK':[],'NC':[],'IL':[],'TX':[],'WA':[],'MO':[],'AZ':[],'NJ':[],'WI':[],'IN':[],'LA':[],'UT':[],'NM':[],'KY':[],'MD':[],'KS':[],'WV':[],'NY':[],'HI':[],'SC':[],'OR':[],'SD':[],'TN':[],'MS':[],'VA':[],'ME':[],'CT':[],'RI':[],'DC':[],'NV':[],'MN':[],'IA':[],'DE':[],'MT':[],'AK':[],'NH':[],'ND':[],'WY':[],'ID':[]};
statepopyear = {'CO':0,'AL':0,'CA':0,'FL':0,'PA':0,'VT':0,'NE':0,'OH':0,'AR':0,'GA':0,'MI':0,'MA':0,'OK':0,'NC':0,'IL':0,'TX':0,'WA':0,'MO':0,'AZ':0,'NJ':0,'WI':0,'IN':0,'LA':0,'UT':0,'NM':0,'KY':0,'MD':0,'KS':0,'WV':0,'NY':0,'HI':0,'SC':0,'OR':0,'SD':0,'TN':0,'MS':0,'VA':0,'ME':0,'CT':0,'RI':0,'DC':0,'NV':0,'MN':0,'IA':0,'DE':0,'MT':0,'AK':0,'NH':0,'ND':0,'WY':0,'ID':0};
stateallsportsyear = {'CO':0,'AL':0,'CA':0,'FL':0,'PA':0,'VT':0,'NE':0,'OH':0,'AR':0,'GA':0,'MI':0,'MA':0,'OK':0,'NC':0,'IL':0,'TX':0,'WA':0,'MO':0,'AZ':0,'NJ':0,'WI':0,'IN':0,'LA':0,'UT':0,'NM':0,'KY':0,'MD':0,'KS':0,'WV':0,'NY':0,'HI':0,'SC':0,'OR':0,'SD':0,'TN':0,'MS':0,'VA':0,'ME':0,'CT':0,'RI':0,'DC':0,'NV':0,'MN':0,'IA':0,'DE':0,'MT':0,'AK':0,'NH':0,'ND':0,'WY':0,'ID':0};
statethissportpt = {'CO':0,'AL':0,'CA':0,'FL':0,'PA':0,'VT':0,'NE':0,'OH':0,'AR':0,'GA':0,'MI':0,'MA':0,'OK':0,'NC':0,'IL':0,'TX':0,'WA':0,'MO':0,'AZ':0,'NJ':0,'WI':0,'IN':0,'LA':0,'UT':0,'NM':0,'KY':0,'MD':0,'KS':0,'WV':0,'NY':0,'HI':0,'SC':0,'OR':0,'SD':0,'TN':0,'MS':0,'VA':0,'ME':0,'CT':0,'RI':0,'DC':0,'NV':0,'MN':0,'IA':0,'DE':0,'MT':0,'AK':0,'NH':0,'ND':0,'WY':0,'ID':0};
statepops = {"AL":[4040587,3894025,3444354,3266740,3061743,2832961,2646248,2348174,2138093,1828697],"AK":[550043,401851,302853,226167,128643,72524,59278,55036,64356,63592],"AZ":[3665228,2716546,1775399,1302161,749587,499261,435573,334162,204354,122931],"AR":[2350725,2286357,1923322,1786272,1909511,1949387,1854482,1752204,1574449,1311564],"CA":[29760021,23667764,19971069,15717204,10586223,6907387,5677251,3426861,2377549,1485053],"CO":[3294394,2889735,2209596,1753947,1325089,1123296,1035791,939629,799024,539700],"CT":[3287116,3107564,3032217,2535234,2007280,1709242,1606903,1380631,1114756,908420],"DE":[666168,594338,548104,446292,318085,266505,230380,223003,202322,184735],"DC":[606900,638432,756668,763956,802178,663091,486869,437571,331069,278718],"FL":[12937926,9746961,6791418,4951560,2771305,1897414,1468211,968470,752619,528542],"GA":[6478216,5462982,4587930,3943116,3444578,3123723,2908506,2895832,2609121,2216331],"HI":[1108229,964691,769913,632772,499794,422770,368300,255881,191874,154001],"ID":[1006749,944127,713015,667191,588637,524873,445032,431866,325594,161772],"IL":[11430602,11427409,11110285,10081158,8712176,7897241,7630654,6485280,5638591,4821550],"IN":[5544159,5490210,5195392,4662498,3934224,3427796,3238503,2930390,2700876,2516462],"IA":[2776755,2913808,2825368,2757537,2621073,2538268,2470939,2404021,2224771,2231853],"KS":[2477574,2364236,2249071,2178611,1905299,1801028,1880999,1769257,1690949,1470495],"KY":[3685296,3660324,3220711,3038156,2944806,2845627,2614589,2416630,2289905,2147174],"LA":[4219973,4206116,3644637,3257022,2683516,2363880,2101593,1798509,1656388,1381625],"ME":[1227928,1125043,993722,969265,913774,847226,797423,768014,742371,694466],"MD":[4781468,4216933,3923897,3100689,2343001,1821244,1631526,1449661,1295346,1188044],"MA":[6016425,5737093,5689170,5148578,4690514,4316721,4249614,3852356,3366416,2805346],"MI":[9295297,9262044,8881826,7823194,6371766,5256106,4842325,3668412,2810173,2420982],"MN":[4375099,4075970,3806103,3413864,2982483,2792300,2563953,2387125,2075708,1751394],"MS":[2573216,2520770,2216994,2178141,2178914,2183796,2009821,1790618,1797114,1551270],"MO":[5117073,4916766,4677623,4319813,3954653,3784664,3629367,3404055,3293335,3106665],"MT":[799065,786690,694409,674767,591024,559456,537606,548889,376053,243329],"NE":[1578385,1569825,1485333,1411330,1325510,1315834,1377963,1296372,1192214,1066300],"NV":[1201833,800508,488738,285278,160083,0,91058,77407,81875,42335],"NH":[1109252,920610,737681,606921,533242,491524,465293,443083,430572,411588],"NJ":[7730188,7365011,7171112,6066782,4835329,4160165,4041334,3155900,2537167,1883669],"NM":[1515069,1303302,1017055,951023,681187,531818,423317,360350,327301,195310],"NY":[17990455,17558165,18241391,16782304,14830192,13479142,12588066,10385227,9113614,7268894],"NC":[6628637,5880095,5084411,4556155,4061929,3571623,3170276,2559123,2206287,1893810],"ND":[638800,652717,617792,632446,619636,641935,680845,646872,577056,319146],"OH":[10847115,10797603,10657423,9706397,7946627,6907612,6646697,5759394,4767121,4157545],"OK":[3145585,3025487,2559463,2328284,2233351,2336434,2396040,2028283,1657155,790391],"OR":[2842321,2633156,2091533,1768687,1521341,1089684,953786,783389,672765,413536],"PA":[11881643,11864720,11800766,11319366,10498012,9900180,9631350,8720017,7665111,6302115],"RI":[1003464,947154,949723,859488,791896,713346,687497,604397,542610,428556],"SC":[3486703,3120729,2590713,2382594,2117027,1899804,1738765,1683724,1515400,1340316],"SD":[696004,690768,666257,680514,652740,642961,692849,636547,583888,401570],"TN":[4877185,4591023,3926018,3567089,3291718,2915841,2616556,2337885,2184789,2020616],"TX":[16986510,14225513,11198655,9579677,7711194,6414824,5824715,4663228,3896542,3048710],"UT":[1722850,1461037,1059273,890627,688862,550310,507847,449396,373351,276749],"VT":[562758,511456,444732,389881,377747,359231,359611,352428,355956,343641],"VA":[6187358,5346797,4651448,3966949,3318680,2677773,2421851,2309187,2061612,1854184],"WA":[4866692,4132353,3413244,2853214,2378963,1736191,1563396,1356621,1141990,518103],"WV":[1793477,1950186,1744237,1860421,2005552,1901974,1729205,1463701,1221119,958800],"WI":[4891769,4705642,4417821,3951777,3434575,3137587,2939006,2632067,2333860,2069042],"WY":[453588,469557,332416,330066,290529,250742,225565,194402,145965,92531]};
var stateptmax;
var i =0;
var years_born = document.getElementById('slider_born');
var years_play = document.getElementById('slider_play');

noUiSlider.create(years_born, {
	start: [1920, 2000],
	connect: true,
	behaviour: 'drag-fixed',
	step: 1,
	range: {
		'min': 1850,
		'max': 2020
	}
});

noUiSlider.create(years_play, {
	start: [1950, 1960],
	connect: true,
	behaviour: 'drag-fixed',
	step: 1,
	range: {
		'min': 1900,
		'max': 2020
	}
});

years_born.noUiSlider.on('update', function( values, handle ) {
	if (parseInt(document.getElementById('start_year_born').value) != parseInt(values[0]) || parseInt(document.getElementById('end_year_born').value) != parseInt(values[1])){

		document.getElementById('start_year_born').value = parseInt(values[0]);
		document.getElementById('end_year_born').value = parseInt(values[1]);
		updateYears(true);
	}
});

years_play.noUiSlider.on('update', function( values, handle ) {
	if (parseInt(document.getElementById('start_year').value) != parseInt(values[0]) || parseInt(document.getElementById('end_year').value) != parseInt(values[1])){

		document.getElementById('start_year').value = parseInt(values[0]);
		document.getElementById('end_year').value = parseInt(values[1]);
		updateYears(false);
	}
});

function updateYears(born){
	var sport_name = document.getElementById('sport').value;
	var sport_id = -1;
	var stat_id = parseInt(document.getElementById('stat').value);
	if (sport_name=='MLB'){
		sport_id=0;
	}
	else if (sport_name=='NBA'){
		sport_id=1;
	}
	else if (sport_name=='NFL'){
		sport_id=2;
	}
	for ( var abbrev in statept ){
		statept[abbrev]=0;
		statepopyear[abbrev]=0;
		stateallsportsyear[abbrev]=0;
		statethissportpt[abbrev]=0;
		statetops[abbrev]=[];
	}
	if (!born){
			
		var start_year = parseInt(document.getElementById('start_year').value);
		var end_year = parseInt(document.getElementById('end_year').value);
		var i;

		for ( var abbrev in statepops ){
			var start_pop = 1;
			if (start_year%10==0 && start_year <=1990 && start_year>=1900){
				start_pop = statepops[abbrev][199-start_year/10];
			}
			else if (start_year >1990){
				start_pop = (statepops[abbrev][0]-statepops[abbrev][1])/10*(start_year-1990)+statepops[abbrev][0];
			}
			else if (start_year <1900){
				start_pop = (statepops[abbrev][9]-statepops[abbrev][8])/10*(1900-start_year)+statepops[abbrev][9];
			}
			else{
				start_pop = (start_year%10)/10*statepops[abbrev][199-Math.trunc(start_year/10)-1]+(10-(start_year%10))/10*statepops[abbrev][199-Math.trunc(start_year/10)];
			}
			var end_pop = 1;
			if (end_year%10==0 && end_year <=1990 && end_year>=1900){
				end_pop = statepops[abbrev][199-end_year/10];
			}
			else if (end_year >1990){
				end_pop = (statepops[abbrev][0]-statepops[abbrev][1])/10*(end_year-1990)+statepops[abbrev][0];
			}
			else if (end_year <1900){
				end_pop = (statepops[abbrev][9]-statepops[abbrev][8])/10*(1900-end_year)+statepops[abbrev][9];
			}
			else{
				end_pop = (end_year%10)/10*statepops[abbrev][199-Math.trunc(end_year/10)-1]+(10-(end_year%10))/10*statepops[abbrev][199-Math.trunc(end_year/10)];
			}
			statepopyear[abbrev]=(start_pop+end_pop)/2;

				
		}
		var sport_total = [0,0,0]; var ii = 0;
		for (i=start_year-1800;i<=end_year-1800;i++){
			for ( var abbrev in statept ){
				statept[abbrev]+=playyears[sport_id][stat_id][i][abbrev];
				
			}	
			
			for ( var abbrev in statept ){
				for (ii=0;ii<3;ii++){
					sport_total[ii]+=playyears[ii][0][i][abbrev];
				}
			}
		}
		for (i=start_year-1800;i<=end_year-1800;i++){
			for ( var abbrev in statept ){
				for (ii=0;ii<3;ii++){
					stateallsportsyear[abbrev]+=playyears[ii][0][i][abbrev]/sport_total[ii];
				}
				statethissportpt[abbrev]+=playyears[sport_id][0][i][abbrev];
			}	
		}

		for (i=0;i<topplayers[sport_id].length;i++){
			if (topplayers[sport_id][i][4]<=end_year && topplayers[sport_id][i][5]>=start_year){
				if (statetops[topplayers[sport_id][i][2]].length<10){
					statetops[topplayers[sport_id][i][2]].push({'name':topplayers[sport_id][i][0],'city':topplayers[sport_id][i][3],'value':topplayers[sport_id][i][6+stat_id]});
					statetops[topplayers[sport_id][i][2]].sort(function (a, b) {  return b.value - a.value;});
				}
				else{
					if (topplayers[sport_id][i][6+stat_id]>statetops[topplayers[sport_id][i][2]][9].value){
						statetops[topplayers[sport_id][i][2]][9]={'name':topplayers[sport_id][i][0],'city':topplayers[sport_id][i][3],'value':topplayers[sport_id][i][6+stat_id]};
					}
					statetops[topplayers[sport_id][i][2]].sort(function (a, b) {  return b.value - a.value;});

				}
				
			}
		}
	}
	else{
		var start_year_born = parseInt(document.getElementById('start_year_born').value);
		var end_year_born = parseInt(document.getElementById('end_year_born').value);
		var start_year = start_year_born+25;
		var end_year = end_year_born+25;
		var i;

		for ( var abbrev in statepops ){
			var start_pop = 1;
			if (start_year%10==0 && start_year <=1990 && start_year>=1900){
				start_pop = statepops[abbrev][199-start_year/10];
			}
			else if (start_year >1990){
				start_pop = (statepops[abbrev][0]-statepops[abbrev][1])/10*(start_year-1990)+statepops[abbrev][0];
			}
			else if (start_year <1900){
				start_pop = (statepops[abbrev][9]-statepops[abbrev][8])/10*(1900-start_year)+statepops[abbrev][9];
			}
			else{
				start_pop = (start_year%10)/10*statepops[abbrev][199-Math.trunc(start_year/10)-1]+(10-(start_year%10))/10*statepops[abbrev][199-Math.trunc(start_year/10)];
			}
			var end_pop = 1;
			if (end_year%10==0 && end_year <=1990 && end_year>=1900){
				end_pop = statepops[abbrev][199-end_year/10];
			}
			else if (end_year >1990){
				end_pop = (statepops[abbrev][0]-statepops[abbrev][1])/10*(end_year-1990)+statepops[abbrev][0];
			}
			else if (end_year <1900){
				end_pop = (statepops[abbrev][9]-statepops[abbrev][8])/10*(1900-end_year)+statepops[abbrev][9];
			}
			else{
				end_pop = (end_year%10)/10*statepops[abbrev][199-Math.trunc(end_year/10)-1]+(10-(end_year%10))/10*statepops[abbrev][199-Math.trunc(end_year/10)];
			}
			statepopyear[abbrev]=(start_pop+end_pop)/2;

				
		}
		var sport_total = [0,0,0]; var ii = 0;
		for (i=start_year_born-1800;i<=end_year_born-1800;i++){
			for ( var abbrev in statept ){
				statept[abbrev]+=birthyears[sport_id][stat_id][i][abbrev];
			}
			
			for ( var abbrev in statept ){
				for (ii=0;ii<3;ii++){
					sport_total[ii]+=birthyears[ii][0][i][abbrev];
				}
			}
		}
		for (i=start_year-1800;i<=end_year-1800;i++){
			for ( var abbrev in statept ){
				for (ii=0;ii<3;ii++){
					stateallsportsyear[abbrev]+=birthyears[ii][0][i][abbrev]/sport_total[ii];
				}
				statethissportpt[abbrev]+=birthyears[sport_id][0][i][abbrev];
			}	
		}
		for (i=0;i<topplayers[sport_id].length;i++){
			if (topplayers[sport_id][i][1]<=end_year_born && topplayers[sport_id][i][1]>=start_year_born){
				if (statetops[topplayers[sport_id][i][2]].length<10){
					statetops[topplayers[sport_id][i][2]].push({'name':topplayers[sport_id][i][0],'city':topplayers[sport_id][i][3],'value':topplayers[sport_id][i][6+stat_id]});
					statetops[topplayers[sport_id][i][2]].sort(function (a, b) {  return b.value - a.value;});
				}
				else{
					if (topplayers[sport_id][i][6+stat_id]>statetops[topplayers[sport_id][i][2]][9].value){
						statetops[topplayers[sport_id][i][2]][9]={'name':topplayers[sport_id][i][0],'city':topplayers[sport_id][i][3],'value':topplayers[sport_id][i][6+stat_id]};
					}
					statetops[topplayers[sport_id][i][2]].sort(function (a, b) {  return b.value - a.value;});
				}
				
			}
		}

	}
	console.log('PA #:',statetops['PA'].length);
	if (document.getElementById('denominator').value=='per capita'){
		for ( var abbrev in statept ){
			statept[abbrev]/=statepopyear[abbrev]/1000.;
		}
	}
	else if (document.getElementById('denominator').value=='sports'){
		for ( var abbrev in statept ){
			if (stateallsportsyear[abbrev]>0){
				statept[abbrev]/=stateallsportsyear[abbrev];
			}
		}
	}
	else if (document.getElementById('denominator').value=='quality'){
		for ( var abbrev in statept ){
			if (statethissportpt[abbrev]>0){
				statept[abbrev]/=statethissportpt[abbrev];
			}
		}
	}
	var maxpop = 0;
	for ( var abbrev in statept ){
		if (statept[abbrev]>maxpop){
			maxpop = statept[abbrev];
		}
	}
	stateptmax=maxpop;
	map_startRenderLoop();
}